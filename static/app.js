/**
 * Ethics AI System â€” Full Browser-Only Implementation
 * All agents, knowledge base, and search run in the browser.
 * Data sources:
 *   - Full Quran (6 236 ayahs) â€” risan/quran-json  (Arabic + Russian)
 *   - Full Sahih al-Bukhari (~7 563 hadith) â€” fawazahmed0/hadith-api (Arabic + Russian)
 */

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CDN DATA SOURCES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CDN = {
    quranRu: "https://cdn.jsdelivr.net/npm/quran-json@3.1.2/dist/quran_ru.json",
    bukhariRu: "https://cdn.jsdelivr.net/gh/fawazahmed0/hadith-api@1/editions/rus-bukhari.min.json",
    bukhariAr: "https://cdn.jsdelivr.net/gh/fawazahmed0/hadith-api@1/editions/ara-bukhari.min.json",
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RUNTIME DATA STORES (populated by loadAllData)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let QURAN_AYAHS = [];   // { id, type, surah, surahRu, num, ar, ru, tags }
let HADITHS = [];   // { id, type, col, n, ar, ru, tags, grade }
let DATA_LOADED = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/** Fetch JSON with timeout */
async function fetchJSON(url, timeoutMs = 30000) {
    const ctrl = new AbortController();
    const tid = setTimeout(() => ctrl.abort(), timeoutMs);
    try {
        const res = await fetch(url, { signal: ctrl.signal });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
    } finally { clearTimeout(tid); }
}

/** Generate basic tags from Russian text */
function autoTags(text) {
    if (!text) return [];
    const kw = {
        "ÑĞ¿Ñ€Ğ°Ğ²ĞµĞ´Ğ»Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ": /ÑĞ¿Ñ€Ğ°Ğ²ĞµĞ´Ğ»Ğ¸Ğ²|Ğ¿Ñ€Ğ°Ğ²Ğ¾ÑÑƒĞ´Ğ¸/i,
        "Ğ¼Ğ¸Ğ»Ğ¾ÑĞµÑ€Ğ´Ğ¸Ğµ": /Ğ¼Ğ¸Ğ»Ğ¾ÑĞµÑ€Ğ´|Ğ¼Ğ¸Ğ»Ğ¾ÑÑ‚|ÑĞ¾ÑÑ‚Ñ€Ğ°Ğ´Ğ°Ğ½/i,
        "Ğ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ¸Ğµ": /Ğ¿Ñ€Ğ¾ÑÑ‚|Ğ¿Ñ€Ğ¾Ñ‰|Ğ¿Ğ¾ĞºĞ°ÑĞ½/i,
        "Ñ‚ĞµÑ€Ğ¿ĞµĞ½Ğ¸Ğµ": /Ñ‚ĞµÑ€Ğ¿|ÑÑ‚Ğ¾Ğ¹Ğº|Ğ²Ñ‹Ğ´ĞµÑ€Ğ¶/i,
        "Ñ‡ĞµÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ": /Ñ‡ĞµÑÑ‚Ğ½|Ğ¿Ñ€Ğ°Ğ²Ğ´Ğ¸Ğ²|Ğ¸ÑĞºÑ€ĞµĞ½Ğ½/i,
        "ÑĞµĞ¼ÑŒÑ": /Ñ€Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»|Ğ¼Ğ°Ñ‚[ÑŒĞ¸]|Ğ¾Ñ‚ĞµÑ†|Ğ±Ñ€Ğ°Ñ‚|ÑĞµÑÑ‚Ñ€|ÑĞµĞ¼ÑŒ|ÑÑƒĞ¿Ñ€ÑƒĞ³|Ğ¶ĞµĞ½[Ğ°Ñ‹Ñƒ]|Ğ¼ÑƒĞ¶/i,
        "Ğ·Ğ½Ğ°Ğ½Ğ¸Ğµ": /Ğ·Ğ½Ğ°Ğ½|ÑƒÑ‡ĞµĞ½|Ğ½Ğ°ÑƒĞº|Ğ¼ÑƒĞ´Ñ€Ğ¾ÑÑ‚/i,
        "Ğ±Ğ»Ğ°Ğ³Ğ¾Ğ´ĞµÑĞ½Ğ¸Ğµ": /Ğ±Ğ»Ğ°Ğ³|Ğ´Ğ¾Ğ±Ñ€|Ğ´Ğ¾Ğ±Ñ€Ğ¾Ğ´ĞµÑ‚ĞµĞ»/i,
        "Ğ·Ğ°Ğ¿Ñ€ĞµÑ‚": /Ğ·Ğ°Ğ¿Ñ€ĞµÑ‚|Ğ·Ğ°Ğ¿Ñ€ĞµÑ‰|Ñ…Ğ°Ñ€Ğ°Ğ¼|Ğ³Ñ€ĞµÑ…/i,
        "Ğ¼Ğ¾Ğ»Ğ¸Ñ‚Ğ²Ğ°": /Ğ¼Ğ¾Ğ»Ğ¸Ñ‚Ğ²|Ğ½Ğ°Ğ¼Ğ°Ğ·|Ğ¿Ğ¾ĞºĞ»Ğ¾Ğ½/i,
        "Ğ²ĞµÑ€Ğ°": /Ğ²ĞµÑ€[Ğ°ÑƒÑ‹]|ÑƒĞ²ĞµÑ€Ğ¾Ğ²|Ğ²ĞµÑ€Ñƒ[ÑÑ]/i,
        "Ğ¿Ğ¾ĞºĞ°ÑĞ½Ğ¸Ğµ": /Ğ¿Ğ¾ĞºĞ°ÑĞ½|Ñ€Ğ°ÑĞºĞ°ÑĞ½|Ğ¿Ğ¾ĞºĞ°Ğ¹Ñ‚/i,
        "Ğ±Ğ»Ğ°Ğ³Ğ¾Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ": /Ğ·Ğ°ĞºÑÑ‚|Ğ¼Ğ¸Ğ»Ğ¾ÑÑ‚Ñ‹Ğ½|ÑĞ°Ğ´Ğ°Ğº|Ğ¿Ğ¾Ğ¶ĞµÑ€Ñ‚Ğ²Ğ¾Ğ²Ğ°Ğ½/i,
        "Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»Ñ": /Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²|ĞºÑƒĞ¿Ğ»|Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶|ÑĞ´ĞµĞ»Ğº/i,
        "Ğ¾Ğ±Ğ¼Ğ°Ğ½": /Ğ¾Ğ±Ğ¼Ğ°Ğ½|Ğ»Ğ¾Ğ¶ÑŒ|Ğ»Ğ¶Ğ¸|Ğ»Ğ³Ñƒ/i,
        "ÑƒĞ±Ğ¸Ğ¹ÑÑ‚Ğ²Ğ¾": /ÑƒĞ±Ğ¸Ğ¹ÑÑ‚Ğ²|ÑƒĞ±Ğ¸[Ğ²Ğ¹Ñ‚]|ĞºÑ€Ğ¾Ğ²/i,
        "Ğ³Ğ¾Ñ€Ğ´Ñ‹Ğ½Ñ": /Ğ³Ğ¾Ñ€Ğ´Ñ‹Ğ½|Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ğ¼ĞµÑ€|Ğ½Ğ°Ğ´Ğ¼ĞµĞ½/i,
        "Ğ·Ğ°Ğ²Ğ¸ÑÑ‚ÑŒ": /Ğ·Ğ°Ğ²Ğ¸ÑÑ‚ÑŒ|Ğ·Ğ°Ğ²Ğ¸Ğ´Ğ¾Ğ²/i,
        "ÑĞ¸Ñ€Ğ¾Ñ‚Ñ‹": /ÑĞ¸Ñ€Ğ¾Ñ‚/i,
        "ÑĞ¾ÑĞµĞ´Ğ¸": /ÑĞ¾ÑĞµĞ´/i,
        "Ğ²Ğ¾Ğ¹Ğ½Ğ°": /Ğ²Ğ¾Ğ¹Ğ½|ÑÑ€Ğ°Ğ¶ĞµĞ½|Ğ±Ğ¸Ñ‚Ğ²|Ğ´Ğ¶Ğ¸Ñ…Ğ°Ğ´/i,
        "Ğ¿Ğ¾ÑÑ‚": /Ğ¿Ğ¾ÑÑ‚[Ğ°ĞµĞ¸Ñƒ]|Ñ€Ğ°Ğ¼Ğ°Ğ´Ğ°Ğ½|Ğ³Ğ¾Ğ²ĞµÑ‚ÑŒ/i,
        "Ğ½Ğ°ÑĞ»ĞµĞ´ÑÑ‚Ğ²Ğ¾": /Ğ½Ğ°ÑĞ»ĞµĞ´ÑÑ‚Ğ²|Ğ·Ğ°Ğ²ĞµÑ‰Ğ°Ğ½/i,
        "Ğ±Ñ€Ğ°Ğº": /Ğ±Ñ€Ğ°Ğº|ÑĞ²Ğ°Ğ´ÑŒĞ±|Ğ½Ğ¸ĞºÑÑ…/i,
        "Ñ€Ğ°Ğ·Ğ²Ğ¾Ğ´": /Ñ€Ğ°Ğ·Ğ²Ğ¾Ğ´|Ñ‚Ğ°Ğ»ÑĞº/i,
        "ĞºĞ»ÑÑ‚Ğ²Ğ°": /ĞºĞ»ÑÑ‚Ğ²|Ğ¾Ğ±ĞµÑ‰Ğ°Ğ½|Ğ¾Ğ±ĞµÑ‚/i,
    };
    const tags = [];
    for (const [tag, rx] of Object.entries(kw)) {
        if (rx.test(text)) tags.push(tag);
    }
    return tags.length ? tags : ["Ğ¾Ğ±Ñ‰Ğ°Ñ Ñ‚ĞµĞ¼Ğ°"];
}

/** Load full Quran from CDN and normalise into QURAN_AYAHS format */
async function loadQuranData(onProgress) {
    onProgress?.("ğŸ“– Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞšĞ¾Ñ€Ğ°Ğ½Ğ°...");
    const surahs = await fetchJSON(CDN.quranRu);
    const ayahs = [];
    for (const s of surahs) {
        for (const v of s.verses) {
            ayahs.push({
                id: `q${s.id}_${v.id}`,
                type: "quran",
                surah: s.translation || s.name,
                num: `${s.id}:${v.id}`,
                ar: v.text,
                ru: v.translation,
                tags: autoTags(v.translation)
            });
        }
    }
    onProgress?.(`ğŸ“– ĞšĞ¾Ñ€Ğ°Ğ½: ${ayahs.length} Ğ°ÑÑ‚Ğ¾Ğ² âœ“`);
    return ayahs;
}

/** Load Sahih al-Bukhari (Russian + Arabic) from CDN */
async function loadBukhariData(onProgress) {
    onProgress?.("ğŸ“œ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¡Ğ°Ñ…Ğ¸Ñ… Ğ°Ğ»ÑŒ-Ğ‘ÑƒÑ…Ğ°Ñ€Ğ¸...");
    const [ruData, arData] = await Promise.all([
        fetchJSON(CDN.bukhariRu),
        fetchJSON(CDN.bukhariAr).catch(() => null)
    ]);

    onProgress?.("âš™ï¸ ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ…Ğ°Ğ´Ğ¸ÑĞ¾Ğ²...");

    // Build Arabic lookup: hadithnumber â†’ text
    const arMap = new Map();
    if (arData) {
        const arSections = arData.hadiths || arData;
        const indexAr = (list) => {
            for (const h of list) {
                const key = String(h.hadithnumber ?? h.hadithNumber ?? h.number ?? "");
                if (key) arMap.set(key, h.text || h.body || "");
            }
        };
        if (Array.isArray(arSections)) {
            indexAr(arSections);
        } else if (typeof arSections === "object") {
            for (const sec of Object.values(arSections)) {
                indexAr(Array.isArray(sec) ? sec : (sec.hadiths || []));
            }
        }
    }

    // Normalise Russian data
    const hadiths = [];
    const ruSections = ruData.hadiths || ruData;
    const processList = (list) => {
        for (const h of list) {
            const num = String(h.hadithnumber ?? h.hadithNumber ?? h.number ?? hadiths.length + 1);
            const ruText = h.text || h.body || "";
            if (!ruText) continue;
            hadiths.push({
                id: `hb${num}`,
                type: "hadith",
                col: "Ğ¡Ğ°Ñ…Ğ¸Ñ… Ğ°Ğ»ÑŒ-Ğ‘ÑƒÑ…Ğ°Ñ€Ğ¸",
                n: Number(num) || hadiths.length + 1,
                nar: "",
                grade: "ÑĞ°Ñ…Ğ¸Ñ…",
                ar: arMap.get(num) || "",
                ru: ruText,
                tags: autoTags(ruText)
            });
        }
    };

    if (Array.isArray(ruSections)) {
        processList(ruSections);
    } else if (typeof ruSections === "object") {
        for (const sec of Object.values(ruSections)) {
            processList(Array.isArray(sec) ? sec : (sec.hadiths || []));
        }
    }

    onProgress?.(`ğŸ“œ Ğ‘ÑƒÑ…Ğ°Ñ€Ğ¸: ${hadiths.length} Ñ…Ğ°Ğ´Ğ¸ÑĞ¾Ğ² âœ“`);
    return hadiths;
}

/** Load all data in parallel */
async function loadAllData(onProgress) {
    try {
        const [quran, bukhari] = await Promise.all([
            loadQuranData(onProgress),
            loadBukhariData(onProgress)
        ]);
        QURAN_AYAHS = quran;
        HADITHS = bukhari;
        DATA_LOADED = true;
        onProgress?.(`âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾: ${quran.length} Ğ°ÑÑ‚Ğ¾Ğ² + ${bukhari.length} Ñ…Ğ°Ğ´Ğ¸ÑĞ¾Ğ²`);
        return true;
    } catch (err) {
        console.error("CDN load failed, using fallback:", err);
        onProgress?.("âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ²ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½ÑƒÑ Ğ±Ğ°Ğ·Ñƒ");
        useFallbackData();
        return false;
    }
}

/** Minimal built-in corpus for offline use */
function useFallbackData() {
    QURAN_AYAHS = [
        { id: "q4_135", type: "quran", surah: "Ğ°Ğ½-ĞĞ¸ÑĞ°", num: "4:135", ar: "ÙŠÙØ§ Ø£ÙÙŠÙÙ‘Ù‡ÙØ§ Ø§Ù„ÙÙ‘Ø°ÙÙŠÙ†Ù Ø¢Ù…ÙÙ†ÙÙˆØ§ ÙƒÙÙˆÙ†ÙÙˆØ§ Ù‚ÙÙˆÙÙ‘Ø§Ù…ÙÙŠÙ†Ù Ø¨ÙØ§Ù„Ù’Ù‚ÙØ³Ù’Ø·Ù Ø´ÙÙ‡ÙØ¯ÙØ§Ø¡Ù Ù„ÙÙ„ÙÙ‘Ù‡Ù", ru: "Ğ Ñ‚Ğµ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ ÑƒĞ²ĞµÑ€Ğ¾Ğ²Ğ°Ğ»Ğ¸! Ğ‘ÑƒĞ´ÑŒÑ‚Ğµ ÑÑ‚Ğ¾Ğ¹ĞºĞ¸ Ğ² ÑĞ¿Ñ€Ğ°Ğ²ĞµĞ´Ğ»Ğ¸Ğ²Ğ¾ÑÑ‚Ğ¸, ÑĞ²Ğ¸Ğ´ĞµÑ‚ĞµĞ»ÑŒÑÑ‚Ğ²ÑƒÑ Ñ€Ğ°Ğ´Ğ¸ ĞĞ»Ğ»Ğ°Ñ…Ğ°, Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ² Ğ²Ğ°Ñ ÑĞ°Ğ¼Ğ¸Ñ….", tags: ["ÑĞ¿Ñ€Ğ°Ğ²ĞµĞ´Ğ»Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ", "ÑĞ²Ğ¸Ğ´ĞµÑ‚ĞµĞ»ÑŒÑÑ‚Ğ²Ğ¾", "Ñ‡ĞµÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ"] },
        { id: "q5_8", type: "quran", surah: "Ğ°Ğ»ÑŒ-ĞœĞ°Ğ¸Ğ´Ğ°", num: "5:8", ar: "Ø§Ø¹Ù’Ø¯ÙÙ„ÙÙˆØ§ Ù‡ÙÙˆÙ Ø£ÙÙ‚Ù’Ø±ÙØ¨Ù Ù„ÙÙ„ØªÙÙ‘Ù‚Ù’ÙˆÙÙ‰Ù°", ru: "Ğ‘ÑƒĞ´ÑŒÑ‚Ğµ ÑĞ¿Ñ€Ğ°Ğ²ĞµĞ´Ğ»Ğ¸Ğ²Ñ‹, Ğ¸Ğ±Ğ¾ ÑÑ‚Ğ¾ Ğ±Ğ»Ğ¸Ğ¶Ğµ Ğº Ğ±Ğ¾Ğ³Ğ¾Ğ±Ğ¾ÑĞ·Ğ½ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸.", tags: ["ÑĞ¿Ñ€Ğ°Ğ²ĞµĞ´Ğ»Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ", "Ğ±ĞµÑĞ¿Ñ€Ğ¸ÑÑ‚Ñ€Ğ°ÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ"] },
        { id: "q16_90", type: "quran", surah: "Ğ°Ğ½-ĞĞ°Ñ…Ğ»ÑŒ", num: "16:90", ar: "Ø¥ÙÙ†ÙÙ‘ Ø§Ù„Ù„ÙÙ‘Ù‡Ù ÙŠÙØ£Ù’Ù…ÙØ±Ù Ø¨ÙØ§Ù„Ù’Ø¹ÙØ¯Ù’Ù„Ù ÙˆÙØ§Ù„Ù’Ø¥ÙØ­Ù’Ø³ÙØ§Ù†Ù", ru: "Ğ’Ğ¾Ğ¸ÑÑ‚Ğ¸Ğ½Ñƒ, ĞĞ»Ğ»Ğ°Ñ… Ğ¿Ğ¾Ğ²ĞµĞ»ĞµĞ²Ğ°ĞµÑ‚ ÑĞ¿Ñ€Ğ°Ğ²ĞµĞ´Ğ»Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ, Ğ±Ğ»Ğ°Ğ³Ğ¾Ğ´ĞµÑĞ½Ğ¸Ğµ Ğ¸ Ñ‰ĞµĞ´Ñ€Ğ¾ÑÑ‚ÑŒ Ğº Ñ€Ğ¾Ğ´ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¸ĞºĞ°Ğ¼.", tags: ["ÑĞ¿Ñ€Ğ°Ğ²ĞµĞ´Ğ»Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ", "Ğ±Ğ»Ğ°Ğ³Ğ¾Ğ´ĞµÑĞ½Ğ¸Ğµ"] },
        { id: "q49_12", type: "quran", surah: "Ğ°Ğ»ÑŒ-Ğ¥ÑƒĞ´Ğ¶ÑƒÑ€Ğ°Ñ‚", num: "49:12", ar: "Ø§Ø¬Ù’ØªÙÙ†ÙØ¨ÙÙˆØ§ ÙƒÙØ«ÙÙŠØ±Ù‹Ø§ Ù…ÙÙ‘Ù†Ù Ø§Ù„Ø¸ÙÙ‘Ù†ÙÙ‘", ru: "Ğ˜Ğ·Ğ±ĞµĞ³Ğ°Ğ¹Ñ‚Ğµ Ğ¼Ğ½Ğ¾Ğ³Ğ¸Ñ… Ğ¿Ñ€ĞµĞ´Ğ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹, Ğ¸Ğ±Ğ¾ Ğ½ĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¿Ñ€ĞµĞ´Ğ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ â€” Ğ³Ñ€ĞµÑ…. ĞĞµ ÑˆĞ¿Ğ¸Ğ¾Ğ½ÑŒÑ‚Ğµ Ğ¸ Ğ½Ğµ Ğ·Ğ»Ğ¾ÑĞ»Ğ¾Ğ²ÑŒÑ‚Ğµ.", tags: ["Ğ·Ğ»Ğ¾ÑĞ»Ğ¾Ğ²Ğ¸Ğµ", "Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€ĞµĞ½Ğ¸Ğµ", "ÑĞ¿Ğ»ĞµÑ‚Ğ½Ğ¸"] },
        { id: "q3_134", type: "quran", surah: "ĞĞ»ÑŒ Ğ˜Ğ¼Ñ€Ğ°Ğ½", num: "3:134", ar: "ÙˆÙØ§Ù„Ù’ÙƒÙØ§Ø¸ÙÙ…ÙÙŠÙ†Ù Ø§Ù„Ù’ØºÙÙŠÙ’Ø¸Ù ÙˆÙØ§Ù„Ù’Ø¹ÙØ§ÙÙÙŠÙ†Ù Ø¹ÙÙ†Ù Ø§Ù„Ù†ÙÙ‘Ø§Ø³Ù", ru: "ĞšĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ ÑĞ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ÑÑ‚ Ğ³Ğ½ĞµĞ² Ğ¸ Ğ¿Ñ€Ğ¾Ñ‰Ğ°ÑÑ‚ Ğ»ÑĞ´ĞµĞ¹. ĞĞ»Ğ»Ğ°Ñ… Ğ»ÑĞ±Ğ¸Ñ‚ Ñ‚Ğ²Ğ¾Ñ€ÑÑ‰Ğ¸Ñ… Ğ´Ğ¾Ğ±Ñ€Ğ¾.", tags: ["Ğ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ¸Ğµ", "Ğ³Ğ½ĞµĞ²", "Ñ‚ĞµÑ€Ğ¿ĞµĞ½Ğ¸Ğµ"] },
    ];
    HADITHS = [
        { id: "hb1", type: "hadith", col: "Ğ¡Ğ°Ñ…Ğ¸Ñ… Ğ°Ğ»ÑŒ-Ğ‘ÑƒÑ…Ğ°Ñ€Ğ¸", n: 1, nar: "Ğ£Ğ¼Ğ°Ñ€ Ğ¸Ğ±Ğ½ Ğ°Ğ»ÑŒ-Ğ¥Ğ°Ñ‚Ñ‚Ğ°Ğ±", grade: "ÑĞ°Ñ…Ğ¸Ñ…", ar: "Ø¥ÙÙ†ÙÙ‘Ù…ÙØ§ Ø§Ù„Ø£ÙØ¹Ù’Ù…ÙØ§Ù„Ù Ø¨ÙØ§Ù„Ù†ÙÙ‘ÙŠÙÙ‘Ø§ØªÙ", ru: "ĞŸĞ¾Ğ¸ÑÑ‚Ğ¸Ğ½Ğµ, Ğ´ĞµĞ»Ğ° Ğ¾Ñ†ĞµĞ½Ğ¸Ğ²Ğ°ÑÑ‚ÑÑ Ğ¿Ğ¾ Ğ½Ğ°Ğ¼ĞµÑ€ĞµĞ½Ğ¸ÑĞ¼.", tags: ["Ğ½Ğ°Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ğµ", "Ğ´ĞµĞ»Ğ°", "Ğ¸ÑĞºÑ€ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ"] },
        { id: "hb13", type: "hadith", col: "Ğ¡Ğ°Ñ…Ğ¸Ñ… Ğ°Ğ»ÑŒ-Ğ‘ÑƒÑ…Ğ°Ñ€Ğ¸", n: 13, nar: "ĞĞ½Ğ°Ñ Ğ¸Ğ±Ğ½ ĞœĞ°Ğ»Ğ¸Ğº", grade: "ÑĞ°Ñ…Ğ¸Ñ…", ar: "Ù„ÙØ§ ÙŠÙØ¤Ù’Ù…ÙÙ†Ù Ø£ÙØ­ÙØ¯ÙÙƒÙÙ…Ù’ Ø­ÙØªÙÙ‘Ù‰ ÙŠÙØ­ÙØ¨ÙÙ‘ Ù„ÙØ£ÙØ®ÙÙŠÙ‡Ù Ù…ÙØ§ ÙŠÙØ­ÙØ¨ÙÙ‘ Ù„ÙÙ†ÙÙÙ’Ø³ÙÙ‡Ù", ru: "ĞĞµ ÑƒĞ²ĞµÑ€ÑƒĞµÑ‚ Ğ½Ğ¸ĞºÑ‚Ğ¾ Ğ¸Ğ· Ğ²Ğ°Ñ, Ğ¿Ğ¾ĞºĞ° Ğ½Ğµ Ğ¿Ğ¾Ğ¶ĞµĞ»Ğ°ĞµÑ‚ Ğ±Ñ€Ğ°Ñ‚Ñƒ Ñ‚Ğ¾, Ñ‡Ñ‚Ğ¾ Ğ¶ĞµĞ»Ğ°ĞµÑ‚ ÑĞµĞ±Ğµ.", tags: ["Ğ±Ñ€Ğ°Ñ‚ÑÑ‚Ğ²Ğ¾", "Ğ»ÑĞ±Ğ¾Ğ²ÑŒ", "Ğ²ĞµÑ€Ğ°"] },
        { id: "hb6018", type: "hadith", col: "Ğ¡Ğ°Ñ…Ğ¸Ñ… Ğ°Ğ»ÑŒ-Ğ‘ÑƒÑ…Ğ°Ñ€Ğ¸", n: 6018, nar: "ĞĞ±Ñƒ Ğ¥ÑƒÑ€Ğ°Ğ¹Ñ€Ğ°", grade: "ÑĞ°Ñ…Ğ¸Ñ…", ar: "Ù…ÙÙ†Ù’ ÙƒÙØ§Ù†Ù ÙŠÙØ¤Ù’Ù…ÙÙ†Ù Ø¨ÙØ§Ù„Ù„ÙÙ‘Ù‡Ù ÙˆÙØ§Ù„Ù’ÙŠÙÙˆÙ’Ù…Ù Ø§Ù„Ø¢Ø®ÙØ±Ù ÙÙÙ„Ù’ÙŠÙÙ‚ÙÙ„Ù’ Ø®ÙÙŠÙ’Ø±Ù‹Ø§ Ø£ÙÙˆÙ’ Ù„ÙÙŠÙØµÙ’Ù…ÙØªÙ’", ru: "ĞšÑ‚Ğ¾ Ğ²ĞµÑ€Ğ¸Ñ‚ Ğ² ĞĞ»Ğ»Ğ°Ñ…Ğ° Ğ¸ Ğ¡ÑƒĞ´Ğ½Ñ‹Ğ¹ Ğ”ĞµĞ½ÑŒ, Ğ¿ÑƒÑÑ‚ÑŒ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ Ğ±Ğ»Ğ°Ğ³Ğ¾Ğµ Ğ¸Ğ»Ğ¸ Ğ¼Ğ¾Ğ»Ñ‡Ğ¸Ñ‚.", tags: ["Ñ€ĞµÑ‡ÑŒ", "Ğ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ğµ", "Ğ²ĞµÑ€Ğ°"] },
    ];
    DATA_LOADED = true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATIC KNOWLEDGE BASE â€” ETHICAL PRINCIPLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PRINCIPLES = [
    {
        id: "eu1", type: "principle", tradition: "Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ğ°Ñ€Ğ¸Ğ·Ğ¼", title: "ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿ Ğ½Ğ°Ğ¸Ğ±Ğ¾Ğ»ÑŒÑˆĞµĞ³Ğ¾ ÑÑ‡Ğ°ÑÑ‚ÑŒÑ",
        ru: "Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ¼Ğ¾Ñ€Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼, ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ¾ Ğ¿Ñ€Ğ¸Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ğº Ğ½Ğ°Ğ¸Ğ±Ğ¾Ğ»ÑŒÑˆĞµĞ¼Ñƒ ÑÑ‡Ğ°ÑÑ‚ÑŒÑ Ğ´Ğ»Ñ Ğ½Ğ°Ğ¸Ğ±Ğ¾Ğ»ÑŒÑˆĞµĞ³Ğ¾ Ñ‡Ğ¸ÑĞ»Ğ° Ğ»ÑĞ´ĞµĞ¹.",
        src: "Ğ”Ğ¶ĞµÑ€ĞµĞ¼Ğ¸ Ğ‘ĞµĞ½Ñ‚Ğ°Ğ¼", tags: ["ÑÑ‡Ğ°ÑÑ‚ÑŒĞµ", "Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑÑ‚Ğ²Ğ¸Ñ", "Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ°", "Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ğ½ÑÑ‚Ğ²Ğ¾"]
    },
    {
        id: "eu2", type: "principle", tradition: "Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ğ°Ñ€Ğ¸Ğ·Ğ¼", title: "ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑÑ‚Ñ€Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ",
        ru: "ĞœĞ¾Ñ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ´Ğ¾Ğ»Ğ³ ÑĞ¾ÑÑ‚Ğ¾Ğ¸Ñ‚ Ğ² Ñ‚Ğ¾Ğ¼, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¾Ğ±Ñ‰ĞµĞµ ÑÑ‚Ñ€Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ, Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ½Ğµ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ ÑÑ‡Ğ°ÑÑ‚ÑŒĞµ.",
        src: "ĞšĞ°Ñ€Ğ» ĞŸĞ¾Ğ¿Ğ¿ĞµÑ€", tags: ["ÑÑ‚Ñ€Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ", "Ğ²Ñ€ĞµĞ´", "Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ", "Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑÑ‚Ğ²Ğ¸Ñ"]
    },
    {
        id: "ed1", type: "principle", tradition: "Ğ”ĞµĞ¾Ğ½Ñ‚Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ", title: "ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¸Ğ¼Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¸Ğ²",
        ru: "ĞŸĞ¾ÑÑ‚ÑƒĞ¿Ğ°Ğ¹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ñ‚Ğ°ĞºĞ¾Ğ¹ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğµ, Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´ÑÑ‚Ğ²ÑƒÑÑÑŒ ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ¹ Ñ‚Ñ‹ Ğ² Ñ‚Ğ¾ Ğ¶Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ¼Ğ¾Ğ¶ĞµÑˆÑŒ Ğ¿Ğ¾Ğ¶ĞµĞ»Ğ°Ñ‚ÑŒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ğ½Ğ° ÑÑ‚Ğ°Ğ»Ğ° Ğ²ÑĞµĞ¾Ğ±Ñ‰Ğ¸Ğ¼ Ğ·Ğ°ĞºĞ¾Ğ½Ğ¾Ğ¼.",
        src: "Ğ˜Ğ¼Ğ¼Ğ°Ğ½ÑƒĞ¸Ğ» ĞšĞ°Ğ½Ñ‚", tags: ["Ğ´Ğ¾Ğ»Ğ³", "ÑƒĞ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ", "Ğ·Ğ°ĞºĞ¾Ğ½", "Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾"]
    },
    {
        id: "ed2", type: "principle", tradition: "Ğ”ĞµĞ¾Ğ½Ñ‚Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ", title: "Ğ¤Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ° Ñ‡ĞµĞ»Ğ¾Ğ²ĞµÑ‡Ğ½Ğ¾ÑÑ‚Ğ¸",
        ru: "ĞŸĞ¾ÑÑ‚ÑƒĞ¿Ğ°Ğ¹ Ñ‚Ğ°Ğº, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñ‚Ñ‹ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ğ»ÑÑ Ğº Ñ‡ĞµĞ»Ğ¾Ğ²ĞµÑ‡ĞµÑÑ‚Ğ²Ñƒ â€” Ğ¸ Ğ² ÑĞ²Ğ¾Ñ‘Ğ¼ Ğ»Ğ¸Ñ†Ğµ, Ğ¸ Ğ² Ğ»Ğ¸Ñ†Ğµ Ğ²ÑÑĞºĞ¾Ğ³Ğ¾ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ³Ğ¾ â€” ĞºĞ°Ğº Ğº Ñ†ĞµĞ»Ğ¸, Ğ° Ğ½Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞºĞ°Ğº Ğº ÑÑ€ĞµĞ´ÑÑ‚Ğ²Ñƒ.",
        src: "Ğ˜Ğ¼Ğ¼Ğ°Ğ½ÑƒĞ¸Ğ» ĞšĞ°Ğ½Ñ‚", tags: ["Ğ´Ğ¾ÑÑ‚Ğ¾Ğ¸Ğ½ÑÑ‚Ğ²Ğ¾", "ÑƒĞ²Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ", "Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº", "Ñ†ĞµĞ»ÑŒ"]
    },
    {
        id: "ed3", type: "principle", tradition: "Ğ”ĞµĞ¾Ğ½Ñ‚Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ", title: "ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿ Ñ‡ĞµÑÑ‚Ğ½Ğ¾ÑÑ‚Ğ¸",
        ru: "Ğ›Ğ¾Ğ¶ÑŒ Ğ¼Ğ¾Ñ€Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ½ĞµĞ´Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ğ¼Ğ° Ğ² Ğ»ÑĞ±Ñ‹Ñ… Ğ¾Ğ±ÑÑ‚Ğ¾ÑÑ‚ĞµĞ»ÑŒÑÑ‚Ğ²Ğ°Ñ…, Ğ¿Ğ¾ÑĞºĞ¾Ğ»ÑŒĞºÑƒ Ğ¾Ğ½Ğ° Ğ¿Ğ¾Ğ´Ñ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ´Ğ¾Ğ²ĞµÑ€Ğ¸Ğµ Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ³Ğ¾ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ°.",
        src: "Ğ˜Ğ¼Ğ¼Ğ°Ğ½ÑƒĞ¸Ğ» ĞšĞ°Ğ½Ñ‚", tags: ["Ñ‡ĞµÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ", "Ğ»Ğ¾Ğ¶ÑŒ", "Ğ´Ğ¾Ğ²ĞµÑ€Ğ¸Ğµ", "Ğ¿Ñ€Ğ°Ğ²Ğ´Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ"]
    },
    {
        id: "ev1", type: "principle", tradition: "Ğ­Ñ‚Ğ¸ĞºĞ° Ğ´Ğ¾Ğ±Ñ€Ğ¾Ğ´ĞµÑ‚ĞµĞ»Ğ¸", title: "Ğ—Ğ¾Ğ»Ğ¾Ñ‚Ğ°Ñ ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ğ°",
        ru: "Ğ”Ğ¾Ğ±Ñ€Ğ¾Ğ´ĞµÑ‚ĞµĞ»ÑŒ â€” ÑÑ‚Ğ¾ ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ğ° Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ´Ğ²ÑƒĞ¼Ñ ĞºÑ€Ğ°Ğ¹Ğ½Ğ¾ÑÑ‚ÑĞ¼Ğ¸: Ğ¸Ğ·Ğ±Ñ‹Ñ‚ĞºĞ¾Ğ¼ Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ¾Ğ¼.",
        src: "ĞÑ€Ğ¸ÑÑ‚Ğ¾Ñ‚ĞµĞ»ÑŒ", tags: ["ÑƒĞ¼ĞµÑ€ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ", "Ğ´Ğ¾Ğ±Ñ€Ğ¾Ğ´ĞµÑ‚ĞµĞ»ÑŒ", "Ğ±Ğ°Ğ»Ğ°Ğ½Ñ", "ĞºÑ€Ğ°Ğ¹Ğ½Ğ¾ÑÑ‚Ğ¸"]
    },
    {
        id: "ev2", type: "principle", tradition: "Ğ­Ñ‚Ğ¸ĞºĞ° Ğ´Ğ¾Ğ±Ñ€Ğ¾Ğ´ĞµÑ‚ĞµĞ»Ğ¸", title: "ĞŸÑ€Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¼ÑƒĞ´Ñ€Ğ¾ÑÑ‚ÑŒ",
        ru: "Ğ¡Ğ¿Ğ¾ÑĞ¾Ğ±Ğ½Ğ¾ÑÑ‚ÑŒ Ñ€Ğ°ÑÑÑƒĞ¶Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾ Ğ¾ Ñ‚Ğ¾Ğ¼, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¾ Ğ¸ Ğ¿Ğ¾Ğ»ĞµĞ·Ğ½Ğ¾ Ğ´Ğ»Ñ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ°, Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾.",
        src: "ĞÑ€Ğ¸ÑÑ‚Ğ¾Ñ‚ĞµĞ»ÑŒ", tags: ["Ğ¼ÑƒĞ´Ñ€Ğ¾ÑÑ‚ÑŒ", "Ñ€Ğ°ÑÑÑƒĞ¶Ğ´ĞµĞ½Ğ¸Ğµ", "Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ", "Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸ĞºĞ°"]
    },
    {
        id: "el1", type: "principle", tradition: "ĞŸÑ€Ğ°Ğ²Ğ¾Ğ²Ñ‹Ğµ Ğ½Ğ¾Ñ€Ğ¼Ñ‹", title: "ĞŸÑ€ĞµĞ·ÑƒĞ¼Ğ¿Ñ†Ğ¸Ñ Ğ½ĞµĞ²Ğ¸Ğ½Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸",
        ru: "ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ ÑÑ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ÑÑ Ğ½ĞµĞ²Ğ¸Ğ½Ğ¾Ğ²Ğ½Ñ‹Ğ¼, Ğ¿Ğ¾ĞºĞ° ĞµĞ³Ğ¾ Ğ²Ğ¸Ğ½Ğ° Ğ½Ğµ Ğ´Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ° Ğ² ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ğ¾Ğ¼ Ğ·Ğ°ĞºĞ¾Ğ½Ğ¾Ğ¼ Ğ¿Ğ¾Ñ€ÑĞ´ĞºĞµ.",
        src: "Ğ’ÑĞµĞ¾Ğ±Ñ‰Ğ°Ñ Ğ´ĞµĞºĞ»Ğ°Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ°Ğ² Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ°, ÑÑ‚. 11", tags: ["Ğ½ĞµĞ²Ğ¸Ğ½Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ", "ÑÑƒĞ´", "ÑĞ¿Ñ€Ğ°Ğ²ĞµĞ´Ğ»Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ", "Ğ·Ğ°ĞºĞ¾Ğ½"]
    },
    {
        id: "el2", type: "principle", tradition: "ĞŸÑ€Ğ°Ğ²Ğ¾Ğ²Ñ‹Ğµ Ğ½Ğ¾Ñ€Ğ¼Ñ‹", title: "ĞŸÑ€Ğ°Ğ²Ğ¾ Ğ½Ğ° Ñ‡Ğ°ÑÑ‚Ğ½ÑƒÑ Ğ¶Ğ¸Ğ·Ğ½ÑŒ",
        ru: "ĞĞ¸ĞºÑ‚Ğ¾ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ğ¾Ğ´Ğ²ĞµÑ€Ğ³Ğ°Ñ‚ÑŒÑÑ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ»ÑŒĞ½Ğ¾Ğ¼Ñƒ Ğ²Ğ¼ĞµÑˆĞ°Ñ‚ĞµĞ»ÑŒÑÑ‚Ğ²Ñƒ Ğ² ĞµĞ³Ğ¾ Ğ»Ğ¸Ñ‡Ğ½ÑƒÑ Ğ¸ ÑĞµĞ¼ĞµĞ¹Ğ½ÑƒÑ Ğ¶Ğ¸Ğ·Ğ½ÑŒ.",
        src: "Ğ’ÑĞµĞ¾Ğ±Ñ‰Ğ°Ñ Ğ´ĞµĞºĞ»Ğ°Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ°Ğ² Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ°, ÑÑ‚. 12", tags: ["Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ", "Ñ‡Ğ°ÑÑ‚Ğ½Ğ°Ñ Ğ¶Ğ¸Ğ·Ğ½ÑŒ", "ÑĞµĞ¼ÑŒÑ", "Ğ¿Ñ€Ğ°Ğ²Ğ°"]
    },
    {
        id: "eg1", type: "principle", tradition: "ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿", title: "Ğ—Ğ¾Ğ»Ğ¾Ñ‚Ğ¾Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ½Ñ€Ğ°Ğ²ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸",
        ru: "ĞŸĞ¾ÑÑ‚ÑƒĞ¿Ğ°Ğ¹ Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼Ğ¸ Ñ‚Ğ°Ğº, ĞºĞ°Ğº Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾ÑÑ‚ÑƒĞ¿Ğ°Ğ»Ğ¸ Ñ Ñ‚Ğ¾Ğ±Ğ¾Ğ¹.",
        src: "Ğ£Ğ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿", tags: ["Ğ·Ğ¾Ğ»Ğ¾Ñ‚Ğ¾Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾", "Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ½Ğ¾ÑÑ‚ÑŒ", "Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ñ", "ÑĞ¼Ğ¿Ğ°Ñ‚Ğ¸Ñ"]
    },
    {
        id: "eg2", type: "principle", tradition: "ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿", title: "ĞĞµ Ğ½Ğ°Ğ²Ñ€ĞµĞ´Ğ¸ (primum non nocere)",
        ru: "ĞŸĞµÑ€Ğ²ĞµĞ¹ÑˆĞ°Ñ Ğ¾Ğ±ÑĞ·Ğ°Ğ½Ğ½Ğ¾ÑÑ‚ÑŒ â€” Ğ½Ğµ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½ÑÑ‚ÑŒ Ğ²Ñ€ĞµĞ´Ğ°. ĞŸÑ€ĞµĞ¶Ğ´Ğµ Ñ‡ĞµĞ¼ Ğ¿Ñ‹Ñ‚Ğ°Ñ‚ÑŒÑÑ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ, ÑƒĞ±ĞµĞ´Ğ¸ÑÑŒ, Ñ‡Ñ‚Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ½ĞµÑÑƒÑ‚ ÑƒÑ‰ĞµÑ€Ğ±Ğ°.",
        src: "Ğ“Ğ¸Ğ¿Ğ¿Ğ¾ĞºÑ€Ğ°Ñ‚", tags: ["Ğ²Ñ€ĞµĞ´", "Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ", "Ğ¼ĞµĞ´Ğ¸Ñ†Ğ¸Ğ½Ğ°", "Ğ¾ÑÑ‚Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ"]
    },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEARCH ENGINE (simple TF-IDF-like keyword matching)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getAllEntries() {
    const entries = [];
    for (const a of QURAN_AYAHS) {
        entries.push({
            id: a.id, type: "quran", title: `ĞšĞ¾Ñ€Ğ°Ğ½, ÑÑƒÑ€Ğ° Â«${a.surah}Â», Ğ°ÑÑ‚ ${a.num}`,
            content: a.ru, arabic: a.ar, tags: a.tags, ref: `Ğ¡ÑƒÑ€Ğ° ${a.num}`
        });
    }
    for (const h of HADITHS) {
        entries.push({
            id: h.id, type: "hadith", title: `${h.col}, â„–${h.n}` + (h.nar ? ` (${h.nar})` : ""),
            content: h.ru, arabic: h.ar, tags: h.tags, ref: `${h.col}, â„–${h.n}`, grade: h.grade
        });
    }
    for (const p of PRINCIPLES) {
        entries.push({
            id: p.id, type: "principle", title: `${p.tradition}: ${p.title}`,
            content: p.ru, tags: p.tags, ref: p.src
        });
    }
    return entries;
}

function searchKnowledge(query, topK = 8) {
    const entries = getAllEntries();
    const qWords = query.toLowerCase().split(/\s+/).filter(w => w.length > 2);
    const scored = entries.map(e => {
        const text = (e.content + " " + e.tags.join(" ")).toLowerCase();
        let score = 0;
        for (const w of qWords) {
            if (text.includes(w)) score += 1;
            for (const tag of e.tags) { if (tag.toLowerCase().includes(w)) score += 2; }
        }
        return { ...e, score };
    });
    scored.sort((a, b) => b.score - a.score);
    return scored.filter(s => s.score > 0).slice(0, topK);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AGENT 1: ANALYST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const STAKEHOLDER_MARKERS = [
    "Ñ", "Ğ¼Ñ‹", "Ğ¾Ğ½", "Ğ¾Ğ½Ğ°", "Ğ¾Ğ½Ğ¸", "ĞºĞ¾Ğ»Ğ»ĞµĞ³Ğ°", "Ğ´Ñ€ÑƒĞ³", "Ñ€Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»Ğ¸", "Ğ¼Ğ°Ñ‚ÑŒ", "Ğ¾Ñ‚ĞµÑ†",
    "Ğ±Ñ€Ğ°Ñ‚", "ÑĞµÑÑ‚Ñ€Ğ°", "Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¸Ğº", "Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒ", "ĞºĞ»Ğ¸ĞµĞ½Ñ‚", "ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸Ğº", "Ğ¿Ğ°Ñ€Ñ‚Ğ½Ñ‘Ñ€",
    "ÑĞ¾ÑĞµĞ´", "Ñ€ĞµĞ±Ñ‘Ğ½Ğ¾Ğº", "ÑĞµĞ¼ÑŒÑ", "Ğ¼ÑƒĞ¶", "Ğ¶ĞµĞ½Ğ°", "Ğ²Ñ€Ğ°Ñ‡", "Ğ¿Ğ°Ñ†Ğ¸ĞµĞ½Ñ‚", "ÑƒÑ‡Ğ¸Ñ‚ĞµĞ»ÑŒ",
    "ÑƒÑ‡ĞµĞ½Ğ¸Ğº", "Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ²ĞµÑ†", "Ğ¿Ğ¾ĞºÑƒĞ¿Ğ°Ñ‚ĞµĞ»ÑŒ", "ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ", "Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ", "Ğ¾Ğ±Ñ‰ĞµÑÑ‚Ğ²Ğ¾", "Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº"
];

function classifyRole(m) {
    const fam = new Set(["Ñ€Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»Ğ¸", "Ğ¼Ğ°Ñ‚ÑŒ", "Ğ¾Ñ‚ĞµÑ†", "Ğ±Ñ€Ğ°Ñ‚", "ÑĞµÑÑ‚Ñ€Ğ°", "ÑĞµĞ¼ÑŒÑ", "Ğ¼ÑƒĞ¶", "Ğ¶ĞµĞ½Ğ°", "Ñ€ĞµĞ±Ñ‘Ğ½Ğ¾Ğº"]);
    const work = new Set(["ĞºĞ¾Ğ»Ğ»ĞµĞ³Ğ°", "Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¸Ğº", "Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒ", "ĞºĞ»Ğ¸ĞµĞ½Ñ‚", "ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸Ğº", "ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ", "Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ"]);
    const soc = new Set(["Ğ´Ñ€ÑƒĞ³", "ÑĞ¾ÑĞµĞ´", "Ğ¾Ğ±Ñ‰ĞµÑÑ‚Ğ²Ğ¾", "Ğ¿Ğ°Ñ€Ñ‚Ğ½Ñ‘Ñ€", "Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº"]);
    const pro = new Set(["Ğ²Ñ€Ğ°Ñ‡", "Ğ¿Ğ°Ñ†Ğ¸ĞµĞ½Ñ‚", "ÑƒÑ‡Ğ¸Ñ‚ĞµĞ»ÑŒ", "ÑƒÑ‡ĞµĞ½Ğ¸Ğº", "Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ²ĞµÑ†", "Ğ¿Ğ¾ĞºÑƒĞ¿Ğ°Ñ‚ĞµĞ»ÑŒ"]);
    if (fam.has(m)) return "Ğ¡ĞµĞ¼ĞµĞ¹Ğ½Ğ°Ñ Ñ€Ğ¾Ğ»ÑŒ";
    if (work.has(m)) return "Ğ Ğ°Ğ±Ğ¾Ñ‡Ğ°Ñ/Ğ´ĞµĞ»Ğ¾Ğ²Ğ°Ñ Ñ€Ğ¾Ğ»ÑŒ";
    if (soc.has(m)) return "Ğ¡Ğ¾Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ñ€Ğ¾Ğ»ÑŒ";
    if (pro.has(m)) return "ĞŸÑ€Ğ¾Ñ„ĞµÑÑĞ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ñ€Ğ¾Ğ»ÑŒ";
    return "Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸Ğº ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ğ¸";
}

function runAnalyst(situation) {
    const logs = [];
    const log = (a) => logs.push({ agent: "ĞĞ³ĞµĞ½Ñ‚-ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸Ğº", action: a, time: new Date().toISOString() });
    log("ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ° ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°");
    const tl = situation.toLowerCase();

    // Stakeholders
    const stakeholders = [];
    const seen = new Set();
    for (const m of STAKEHOLDER_MARKERS) {
        if (tl.includes(m) && !seen.has(m)) {
            seen.add(m);
            stakeholders.push({ name: m.charAt(0).toUpperCase() + m.slice(1), role: classifyRole(m) });
        }
    }
    if (!stakeholders.length) stakeholders.push({ name: "ĞĞ²Ñ‚Ğ¾Ñ€ ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ğ¸", role: "Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞµ Ğ»Ğ¸Ñ†Ğ¾" });
    log("Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ñ‹ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸: " + stakeholders.length);

    // Conflicts
    const conflicts = [];
    if (/Ğ½Ğ¾|Ğ¾Ğ´Ğ½Ğ°ĞºĞ¾|Ñ…Ğ¾Ñ‚Ñ|Ğ½ĞµÑĞ¼Ğ¾Ñ‚Ñ€Ñ/.test(tl))
        conflicts.push({ type: "Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞµ Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ²Ğ¾Ñ€ĞµÑ‡Ğ¸Ğµ", desc: "ĞŸÑ€Ğ¸ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ²Ğ¾Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹.", sev: "Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹" });
    if (/Ğ²Ñ‹Ğ±Ğ¾Ñ€|Ğ´Ğ¸Ğ»ĞµĞ¼Ğ¼Ğ°|\bĞ¸Ğ»Ğ¸\b|Ğ»Ğ¸Ğ±Ğ¾/.test(tl))
        conflicts.push({ type: "Ğ”Ğ¸Ğ»ĞµĞ¼Ğ¼Ğ° Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ°", desc: "Ğ¡Ğ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ñ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ°Ğ¼Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹.", sev: "Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹" });
    if (/Ğ¾Ğ±Ğ¼Ğ°Ğ½|Ğ»Ğ¾Ğ¶ÑŒ|ÑĞºÑ€Ñ‹Ñ‚ÑŒ|Ğ¿Ñ€Ğ¾Ğ¼Ğ¾Ğ»Ñ‡Ğ°Ñ‚ÑŒ/.test(tl))
        conflicts.push({ type: "ĞšĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚ Ñ‡ĞµÑÑ‚Ğ½Ğ¾ÑÑ‚Ğ¸", desc: "Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ Ğ¿Ñ€Ğ°Ğ²Ğ´Ğ¸Ğ²Ğ¾ÑÑ‚Ğ¸, ÑĞ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ğ¼Ğ°Ğ½Ğ°.", sev: "Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹" });
    if (/Ğ½Ğ°Ğ²Ñ€ĞµĞ´Ğ¸Ñ‚ÑŒ|Ğ¿Ğ¾ÑÑ‚Ñ€Ğ°Ğ´Ğ°ĞµÑ‚|Ğ½Ğ°Ñ€ÑƒÑˆĞ¸Ñ‚ÑŒ|Ğ²Ñ€ĞµĞ´/.test(tl))
        conflicts.push({ type: "ĞšĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚ Ğ²Ñ€ĞµĞ´Ğ°", desc: "Ğ¡Ğ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ñ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ²ĞµÑÑ‚Ğ¸ Ğº Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½ĞµĞ½Ğ¸Ñ Ğ²Ñ€ĞµĞ´Ğ°.", sev: "Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹" });
    if (/Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ñ‚ÑŒ|Ğ½Ğ°ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ|Ğ¼ĞµÑÑ‚ÑŒ/.test(tl))
        conflicts.push({ type: "ĞšĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚ ÑĞ¿Ñ€Ğ°Ğ²ĞµĞ´Ğ»Ğ¸Ğ²Ğ¾ÑÑ‚Ğ¸", desc: "Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ¸ĞµĞ¼ Ğ¸ Ğ½Ğ°ĞºĞ°Ğ·Ğ°Ğ½Ğ¸ĞµĞ¼.", sev: "Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹" });
    if (/Ğ½Ğµ Ğ·Ğ½Ğ°Ñ|ÑĞ¾Ğ¼Ğ½ĞµĞ²Ğ°ÑÑÑŒ|Ğ½Ğµ ÑƒĞ²ĞµÑ€ĞµĞ½|ĞºĞ°Ğº Ğ±Ñ‹Ñ‚ÑŒ/.test(tl))
        conflicts.push({ type: "ĞœĞ¾Ñ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ½ĞµĞ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ñ‘Ğ½Ğ½Ğ¾ÑÑ‚ÑŒ", desc: "ĞĞ²Ñ‚Ğ¾Ñ€ Ğ²Ñ‹Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚ Ğ½ĞµÑƒĞ²ĞµÑ€ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ Ğ² Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹.", sev: "Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹" });
    if (!conflicts.length)
        conflicts.push({ type: "ĞĞµÑĞ²Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚", desc: "ĞšĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ½Ñ‹Ğµ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ½Ğµ Ğ²Ñ‹Ñ€Ğ°Ğ¶ĞµĞ½Ñ‹ ÑĞ²Ğ½Ğ¾.", sev: "ĞĞ¸Ğ·ĞºĞ¸Ğ¹" });
    log("Ğ’Ñ‹ÑĞ²Ğ»ĞµĞ½Ñ‹ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ñ‹: " + conflicts.length);

    // Consequences
    const consequences = [];
    for (const s of stakeholders.slice(0, 3)) {
        consequences.push({
            who: s.name,
            pos: `Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ Ğ² Ğ¿Ğ¾Ğ»ÑŒĞ·Ñƒ ${s.name.toLowerCase()} Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑƒĞºÑ€ĞµĞ¿Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ñ Ğ¸ Ğ´Ğ¾Ğ²ĞµÑ€Ğ¸Ğµ.`,
            neg: `Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑĞ¾Ğ² ${s.name.toLowerCase()} Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑƒÑ…ÑƒĞ´ÑˆĞ¸Ñ‚ÑŒ Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ñ.`
        });
    }
    for (const c of conflicts) {
        if (c.type === "ĞšĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚ Ñ‡ĞµÑÑ‚Ğ½Ğ¾ÑÑ‚Ğ¸")
            consequences.push({ who: "Ğ’ÑĞµ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹", pos: "Ğ§ĞµÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ ÑƒĞºÑ€ĞµĞ¿Ğ¸Ñ‚ Ğ´Ğ¾Ğ»Ğ³Ğ¾ÑÑ€Ğ¾Ñ‡Ğ½Ğ¾Ğµ Ğ´Ğ¾Ğ²ĞµÑ€Ğ¸Ğµ.", neg: "ĞŸÑ€Ğ°Ğ²Ğ´Ğ° Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ğ²Ñ‹Ğ·Ğ²Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒ." });
        if (c.type === "ĞšĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚ Ğ²Ñ€ĞµĞ´Ğ°")
            consequences.push({ who: "Ğ’ÑĞµ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹", pos: "ĞŸÑ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ Ğ²Ñ€ĞµĞ´Ğ° Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ¸Ñ‚ ÑƒÑĞ·Ğ²Ğ¸Ğ¼Ñ‹Ğµ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹.", neg: "Ğ‘ĞµĞ·Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ²ĞµÑÑ‚Ğ¸ Ğº ÑĞµÑ€ÑŒÑ‘Ğ·Ğ½Ğ¾Ğ¼Ñƒ Ğ²Ñ€ĞµĞ´Ñƒ." });
    }
    log("Ğ¡Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑÑ‚Ğ²Ğ¸Ñ");

    const ctxt = conflicts.map(c => c.type.toLowerCase()).join(", ");
    const summary = `Ğ¡Ğ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ñ Ğ·Ğ°Ñ‚Ñ€Ğ°Ğ³Ğ¸Ğ²Ğ°ĞµÑ‚ ${stakeholders.length} ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸Ğº(Ğ¾Ğ²). Ğ’Ñ‹ÑĞ²Ğ»ĞµĞ½Ğ¾ ${conflicts.length} ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ½Ñ‹Ğ¹(Ñ…) ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚(Ğ¾Ğ²): ${ctxt}. Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ñ€Ğ°ÑÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑÑ‹ Ğ²ÑĞµÑ… ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½.`;

    return {
        summary, stakeholders, conflicts, consequences, logs,
        note: "Ğ­Ñ‚Ğ¾ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ğ¸. ĞĞ½ Ğ½Ğµ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ¼Ğ¾Ñ€Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¾Ñ†ĞµĞ½Ğ¾Ğº."
    };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AGENT 2: VALUES INTERPRETER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function runValues(situation, analystResult) {
    const logs = [];
    const log = (a) => logs.push({ agent: "ĞĞ³ĞµĞ½Ñ‚-Ğ˜Ğ½Ñ‚ĞµÑ€Ğ¿Ñ€ĞµÑ‚Ğ°Ñ‚Ğ¾Ñ€", action: a, time: new Date().toISOString() });
    log("ĞĞ°Ñ‡Ğ°Ñ‚ Ğ¿Ğ¾Ğ¸ÑĞº Ñ€ĞµĞ»ĞµĞ²Ğ°Ğ½Ñ‚Ğ½Ñ‹Ñ… Ñ†ĞµĞ½Ğ½Ğ¾ÑÑ‚ĞµĞ¹");

    let query = situation;
    for (const c of analystResult.conflicts) query += " " + c.desc;
    log("ĞŸĞ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ");

    const results = searchKnowledge(query, 10);
    log("ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¾Ğ²: " + results.length);

    // Group by type
    const groups = { quran: { label: "ğŸ“– Ğ¡Ğ²ÑÑ‰ĞµĞ½Ğ½Ñ‹Ğ¹ ĞšĞ¾Ñ€Ğ°Ğ½", items: [] }, hadith: { label: "ğŸ“œ Ğ¥Ğ°Ğ´Ğ¸ÑÑ‹ ĞŸÑ€Ğ¾Ñ€Ğ¾ĞºĞ° ï·º", items: [] }, principle: { label: "âš–ï¸ Ğ­Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ñ‹", items: [] } };
    for (const r of results) {
        const item = { title: r.title, content: r.content, ref: r.ref, score: r.score };
        if (r.arabic) item.arabic = r.arabic;
        if (r.grade) item.grade = r.grade;
        if (groups[r.type]) groups[r.type].items.push(item);
    }
    const filteredGroups = {};
    for (const [k, v] of Object.entries(groups)) { if (v.items.length) filteredGroups[k] = v; }

    // Interpretations
    const interps = [];
    if (filteredGroups.quran) {
        interps.push({
            perspective: "ĞšĞ¾Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ²Ğ·Ğ³Ğ»ÑĞ´",
            desc: `ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ ${filteredGroups.quran.items.length} Ñ€ĞµĞ»ĞµĞ²Ğ°Ğ½Ñ‚Ğ½Ñ‹Ñ… Ğ°ÑÑ‚Ğ¾Ğ². Ğ¢ĞµĞºÑÑ‚Ñ‹ ĞšĞ¾Ñ€Ğ°Ğ½Ğ° Ğ¿Ñ€Ğ¸Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ Ğº Ñ€Ğ°Ğ·Ğ¼Ñ‹ÑˆĞ»ĞµĞ½Ğ¸Ñ, Ğ¿Ğ¾Ğ´Ñ‡Ñ‘Ñ€ĞºĞ¸Ğ²Ğ°Ñ ÑĞ¿Ñ€Ğ°Ğ²ĞµĞ´Ğ»Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ, Ğ¼Ğ¸Ğ»Ğ¾ÑĞµÑ€Ğ´Ğ¸Ğµ Ğ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ.`,
            note: "Ğ˜Ğ½Ñ‚ĞµÑ€Ğ¿Ñ€ĞµÑ‚Ğ°Ñ†Ğ¸Ñ Ğ°ÑÑ‚Ğ¾Ğ² Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ°Ñ‚ÑŒÑÑ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ° Ğ¸ ÑˆĞºĞ¾Ğ»Ñ‹ Ñ‚Ğ°Ñ„ÑĞ¸Ñ€Ğ°."
        });
    }
    if (filteredGroups.hadith) {
        interps.push({
            perspective: "ĞŸÑ€Ğ¾Ñ€Ğ¾Ñ‡ĞµÑĞºĞ°Ñ Ñ‚Ñ€Ğ°Ğ´Ğ¸Ñ†Ğ¸Ñ (Ğ¡ÑƒĞ½Ğ½Ğ°)",
            desc: `ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ ${filteredGroups.hadith.items.length} Ñ€ĞµĞ»ĞµĞ²Ğ°Ğ½Ñ‚Ğ½Ñ‹Ñ… Ñ…Ğ°Ğ´Ğ¸ÑĞ¾Ğ². ĞŸÑ€Ğ¾Ñ€Ğ¾Ñ‡ĞµÑĞºĞ°Ñ Ñ‚Ñ€Ğ°Ğ´Ğ¸Ñ†Ğ¸Ñ Ğ´Ğ°Ñ‘Ñ‚ Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹ Ğ½Ñ€Ğ°Ğ²ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ.`,
            note: "ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ…Ğ°Ğ´Ğ¸Ñ Ğ¸Ğ¼ĞµĞµÑ‚ ÑÑ‚ĞµĞ¿ĞµĞ½ÑŒ Ğ´Ğ¾ÑÑ‚Ğ¾Ğ²ĞµÑ€Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ¸."
        });
    }
    if (filteredGroups.principle) {
        const traditions = [...new Set(filteredGroups.principle.items.map(i => i.title.split(":")[0].trim()))];
        interps.push({
            perspective: "Ğ¤Ğ¸Ğ»Ğ¾ÑĞ¾Ñ„ÑĞºĞ¾-ÑÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ²Ğ·Ğ³Ğ»ÑĞ´",
            desc: `Ğ¡Ğ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ñ Ñ€Ğ°ÑÑĞ¼Ğ°Ñ‚Ñ€Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ñ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹: ${traditions.join(", ")}. Ğ Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ñ‚Ñ€Ğ°Ğ´Ğ¸Ñ†Ğ¸Ğ¸ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸.`,
            note: "Ğ¤Ğ¸Ğ»Ğ¾ÑĞ¾Ñ„ÑĞºĞ¸Ğµ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ñ‹ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½ÑÑÑ‚, Ğ½Ğ¾ Ğ½Ğµ Ğ·Ğ°Ğ¼ĞµĞ½ÑÑÑ‚ Ñ€ĞµĞ»Ğ¸Ğ³Ğ¸Ğ¾Ğ·Ğ½Ñ‹Ğµ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¸."
        });
    }
    if (!interps.length) {
        interps.push({ perspective: "ĞĞ±Ñ‰ĞµĞµ Ğ·Ğ°Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ", desc: "ĞŸĞ¾ Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¹ ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ñ€ĞµĞ»ĞµĞ²Ğ°Ğ½Ñ‚Ğ½Ñ‹Ñ… Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¾Ğ².", note: "Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ ĞºĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ñ†Ğ¸Ñ ÑĞ¾ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚Ğ¾Ğ¼." });
    }
    log("Ğ¡Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ¿Ñ€ĞµÑ‚Ğ°Ñ†Ğ¸Ğ¸: " + interps.length);

    return {
        sources: filteredGroups, interpretations: interps, logs,
        note: "ĞŸÑ€Ğ¸Ğ²ĞµĞ´Ñ‘Ğ½Ğ½Ñ‹Ğµ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¸ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ÑÑÑ‚ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ·Ñ€ĞµĞ½Ğ¸Ñ. Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ½Ğµ Ğ²Ñ‹Ğ½Ğ¾ÑĞ¸Ñ‚ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğ¹."
    };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AGENT 3: REFLECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function runReflection(situation, analystResult, valuesResult) {
    const logs = [];
    const log = (a) => logs.push({ agent: "ĞĞ³ĞµĞ½Ñ‚-Ğ ĞµÑ„Ğ»ĞµĞºÑĞ¸Ğ¸", action: a, time: new Date().toISOString() });
    log("ĞĞ°Ñ‡Ğ°Ñ‚ ÑÑ‚Ğ°Ğ¿ Ñ€ĞµÑ„Ğ»ĞµĞºÑĞ¸Ğ¸");
    const tl = situation.toLowerCase();

    // Intention questions
    const iq = [
        { q: "ĞšĞ°ĞºĞ¾Ğ²Ğ° Ğ²Ğ°ÑˆĞ° Ğ³Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ğ¼Ğ¾Ñ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ñ Ğ² ÑÑ‚Ğ¾Ğ¹ ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ğ¸?", p: "ĞŸĞ¾Ğ½ÑÑ‚ÑŒ Ğ¸ÑÑ‚Ğ¸Ğ½Ğ½Ñ‹Ğµ Ğ½Ğ°Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ğ¾Ñ‚Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¸ Ğ¾Ñ‚ Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹." },
        { q: "Ğ•ÑĞ»Ğ¸ Ğ±Ñ‹ Ğ½Ğ¸ĞºÑ‚Ğ¾ Ğ½Ğµ ÑƒĞ·Ğ½Ğ°Ğ» Ğ¾ Ğ²Ğ°ÑˆĞµĞ¼ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğ¸, Ğ¿Ğ¾ÑÑ‚ÑƒĞ¿Ğ¸Ğ»Ğ¸ Ğ±Ñ‹ Ğ²Ñ‹ Ñ‚Ğ°Ğº Ğ¶Ğµ?", p: "ĞŸĞ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ğ¾Ñ†ĞµĞ½Ğ¸Ñ‚ÑŒ, Ğ´Ğ²Ğ¸Ğ¶ĞµÑ‚ Ğ»Ğ¸ Ğ²Ğ°Ğ¼Ğ¸ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞµ ÑƒĞ±ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¸Ğ»Ğ¸ Ğ²Ğ½ĞµÑˆĞ½ĞµĞµ Ğ´Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ." },
    ];
    if (analystResult.stakeholders.length > 1)
        iq.push({ q: "Ğ§ÑŒĞ¸ Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑÑ‹ Ğ´Ğ»Ñ Ğ²Ğ°Ñ Ğ½Ğ°Ğ¸Ğ±Ğ¾Ğ»ĞµĞµ Ğ²Ğ°Ğ¶Ğ½Ñ‹ Ğ¸ Ğ¿Ğ¾Ñ‡ĞµĞ¼Ñƒ?", p: "ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ğ¾Ğ² Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ·Ğ°Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑĞ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ°Ğ¼Ğ¸." });
    if (/ÑĞºÑ€Ñ‹Ñ‚ÑŒ|Ğ¾Ğ±Ğ¼Ğ°Ğ½|Ğ»Ğ¾Ğ¶ÑŒ|Ğ¿Ñ€Ğ¾Ğ¼Ğ¾Ğ»Ñ‡Ğ°Ñ‚ÑŒ/.test(tl))
        iq.push({ q: "Ğ§Ñ‚Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ğ²Ñ‹ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ¸Ñ‚ÑŒ, ÑĞºÑ€Ñ‹Ğ²Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ? Ğ¡ĞµĞ±Ñ Ğ¸Ğ»Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ³Ğ¾?", p: "Ğ Ğ°Ğ·Ğ»Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¾Ğ¹ Ğ»Ğ¶Ğ¸ Ğ¸ ÑĞ³Ğ¾Ğ¸ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¼Ğ°Ğ½Ğ°." });
    if (/Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ñ‚ÑŒ|Ğ½Ğ°ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ|Ğ¼ĞµÑÑ‚ÑŒ/.test(tl))
        iq.push({ q: "Ğ’Ğ°ÑˆĞµ Ğ¶ĞµĞ»Ğ°Ğ½Ğ¸Ğµ â€” Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¿Ñ€Ğ°Ğ²ĞµĞ´Ğ»Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¸Ñ‚ÑŒ Ğ½Ğ° Ğ±Ğ¾Ğ»ÑŒ?", p: "Ğ Ğ°Ğ·Ğ»Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ ÑÑ‚Ñ€ĞµĞ¼Ğ»ĞµĞ½Ğ¸Ñ Ğº ÑĞ¿Ñ€Ğ°Ğ²ĞµĞ´Ğ»Ğ¸Ğ²Ğ¾ÑÑ‚Ğ¸ Ğ¸ Ğ¼ĞµÑÑ‚Ğ¸." });
    log("Ğ’Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¾ Ğ½Ğ°Ğ¼ĞµÑ€ĞµĞ½Ğ¸ÑÑ…: " + iq.length);

    // Consequence questions
    const cq = [
        { q: "ĞšĞ°Ğº Ğ²Ğ°ÑˆĞµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ²Ğ»Ğ¸ÑĞµÑ‚ Ğ½Ğ° ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· Ğ½ĞµĞ´ĞµĞ»Ñ? Ğ§ĞµÑ€ĞµĞ· Ğ³Ğ¾Ğ´? Ğ§ĞµÑ€ĞµĞ· Ğ´ĞµÑÑÑ‚ÑŒ Ğ»ĞµÑ‚?", p: "ĞšÑ€Ğ°Ñ‚ĞºĞ¾ÑÑ€Ğ¾Ñ‡Ğ½Ñ‹Ğµ Ğ¸ Ğ´Ğ¾Ğ»Ğ³Ğ¾ÑÑ€Ğ¾Ñ‡Ğ½Ñ‹Ğµ Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑÑ‚Ğ²Ğ¸Ñ Ğ¼Ğ¾Ğ³ÑƒÑ‚ ÑĞ¸Ğ»ÑŒĞ½Ğ¾ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ°Ñ‚ÑŒÑÑ." },
        { q: "ĞšÑ‚Ğ¾, ĞºÑ€Ğ¾Ğ¼Ğµ Ğ½ĞµĞ¿Ğ¾ÑÑ€ĞµĞ´ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ñ… ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ², Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ·Ğ°Ñ‚Ñ€Ğ¾Ğ½ÑƒÑ‚ Ğ²Ğ°ÑˆĞ¸Ğ¼ Ñ€ĞµÑˆĞµĞ½Ğ¸ĞµĞ¼?", p: "ĞŸĞ¾ÑĞ»ĞµĞ´ÑÑ‚Ğ²Ğ¸Ñ Ñ‡Ğ°ÑÑ‚Ğ¾ Ñ€Ğ°ÑĞ¿Ñ€Ğ¾ÑÑ‚Ñ€Ğ°Ğ½ÑÑÑ‚ÑÑ ÑˆĞ¸Ñ€Ğµ, Ñ‡ĞµĞ¼ ĞºĞ°Ğ¶ĞµÑ‚ÑÑ." },
        { q: "ĞšĞ°ĞºĞ¾Ğ¹ Ğ¸Ğ· Ğ²Ñ‹ÑĞ²Ğ»ĞµĞ½Ğ½Ñ‹Ñ… Ñ€Ğ¸ÑĞºĞ¾Ğ² Ğ´Ğ»Ñ Ğ²Ğ°Ñ Ğ½Ğ°Ğ¸Ğ¼ĞµĞ½ĞµĞµ Ğ´Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ğ¼?", p: "ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ ĞºÑ€Ğ°ÑĞ½Ñ‹Ñ… Ğ»Ğ¸Ğ½Ğ¸Ğ¹ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ ÑÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ€Ğ°Ğ½ÑÑ‚Ğ²Ğ¾ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğ¹." },
        { q: "Ğ•ÑĞ»Ğ¸ Ğ±Ñ‹ Ğ²Ñ‹ ÑƒĞ·Ğ½Ğ°Ğ»Ğ¸ Ğ¾ Ğ¿Ğ¾Ğ´Ğ¾Ğ±Ğ½Ğ¾Ğ¼ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ³Ğ¾ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ°, ĞºĞ°Ğº Ğ±Ñ‹ Ğ²Ñ‹ ĞµĞ³Ğ¾ Ğ¾Ñ†ĞµĞ½Ğ¸Ğ»Ğ¸?", p: "Ğ’Ğ·Ğ³Ğ»ÑĞ´ ÑĞ¾ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹ Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¿ĞµÑ€ÑĞ¿ĞµĞºÑ‚Ğ¸Ğ²Ñ‹." },
    ];
    log("Ğ’Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¾ Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑÑ‚Ğ²Ğ¸ÑÑ…: " + cq.length);

    // Value questions
    const vq = [
        { q: "ĞšĞ°ĞºĞ¸Ğµ Ğ¸Ğ· Ğ²Ğ°ÑˆĞ¸Ñ… Ğ¶Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ñ‹Ñ… Ñ†ĞµĞ½Ğ½Ğ¾ÑÑ‚ĞµĞ¹ Ğ½Ğ°Ğ¸Ğ±Ğ¾Ğ»ĞµĞµ Ğ·Ğ°Ñ‚Ñ€Ğ¾Ğ½ÑƒÑ‚Ñ‹ ÑÑ‚Ğ¾Ğ¹ ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸ĞµĞ¹?", p: "ĞÑĞ¾Ğ·Ğ½Ğ°Ğ½Ğ¸Ğµ ÑĞ¾Ğ±ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ñ†ĞµĞ½Ğ½Ğ¾ÑÑ‚ĞµĞ¹ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚ÑŒ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ." },
    ];
    if (valuesResult.sources.quran)
        vq.push({ q: "ĞšĞ°ĞºĞ¾Ğ¹ Ğ¸Ğ· Ğ¿Ñ€Ğ¸Ğ²ĞµĞ´Ñ‘Ğ½Ğ½Ñ‹Ñ… Ğ°ÑÑ‚Ğ¾Ğ² ĞšĞ¾Ñ€Ğ°Ğ½Ğ° Ğ½Ğ°Ğ¸Ğ±Ğ¾Ğ»ĞµĞµ Ñ€ĞµĞ·Ğ¾Ğ½Ğ¸Ñ€ÑƒĞµÑ‚ Ñ Ğ²Ğ°ÑˆĞ¸Ğ¼ Ğ¾Ñ‰ÑƒÑ‰ĞµĞ½Ğ¸ĞµĞ¼ ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ğ¸?", p: "Ğ›Ğ¸Ñ‡Ğ½Ğ°Ñ ÑĞ²ÑĞ·ÑŒ Ñ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ€Ğ°Ğ·Ğ¼Ñ‹ÑˆĞ»ĞµĞ½Ğ¸Ñ." });
    if (valuesResult.sources.hadith)
        vq.push({ q: "ĞšĞ°ĞºĞ¾Ğ¹ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ Ğ¸Ğ· Ğ¶Ğ¸Ğ·Ğ½Ğ¸ ĞŸÑ€Ğ¾Ñ€Ğ¾ĞºĞ° ï·º Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ²Ğ°Ğ¼ Ğ½Ğ° ÑƒĞ¼ Ğ² ÑĞ²ÑĞ·Ğ¸ Ñ ÑÑ‚Ğ¾Ğ¹ ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸ĞµĞ¹?", p: "ĞŸÑ€Ğ¾Ñ€Ğ¾Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹ Ğ´Ğ°ÑÑ‚ Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¾Ñ€Ğ¸ĞµĞ½Ñ‚Ğ¸Ñ€Ñ‹." });
    vq.push({ q: "Ğ•ÑĞ»Ğ¸ Ğ±Ñ‹ Ğ²Ñ‹ Ğ¾Ğ±ÑŠÑÑĞ½ÑĞ»Ğ¸ ÑĞ²Ğ¾Ñ‘ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºÑƒ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ³Ğ¾ ÑƒĞ²Ğ°Ğ¶Ğ°ĞµÑ‚Ğµ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ²ÑĞµĞ³Ğ¾ â€” Ñ‡Ñ‚Ğ¾ Ğ±Ñ‹ Ğ²Ñ‹ ÑĞºĞ°Ğ·Ğ°Ğ»Ğ¸?", p: "ĞœÑ‹ÑĞ»ĞµĞ½Ğ½Ñ‹Ğ¹ ÑĞºÑĞ¿ĞµÑ€Ğ¸Ğ¼ĞµĞ½Ñ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ Ğ½Ğ° Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ Ñ‡ĞµÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ." });
    log("Ğ’Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¾ Ñ†ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑÑ…: " + vq.length);

    // Meta questions
    const mq = [
        { q: "Ğ”Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ»Ğ¸ Ñƒ Ğ²Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚Ğ¸Ñ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ, Ğ¸Ğ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ ĞµÑ‰Ñ‘?", p: "Ğ˜Ğ½Ğ¾Ğ³Ğ´Ğ° Ğ¼Ğ¾Ñ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ½ĞµĞ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ñ‘Ğ½Ğ½Ğ¾ÑÑ‚ÑŒ â€” ÑĞ»ĞµĞ´ÑÑ‚Ğ²Ğ¸Ğµ Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ° Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸." },
        { q: "Ğ•ÑÑ‚ÑŒ Ğ»Ğ¸ Ğ´Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸, Ğ¸Ğ»Ğ¸ Ğ²Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»Ğ¸Ñ‚ÑŒ ÑĞµĞ±Ğµ Ğ¿Ğ¾Ğ´ÑƒĞ¼Ğ°Ñ‚ÑŒ?", p: "Ğ¡Ñ€Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ Ğ²Ğ»Ğ¸ÑĞµÑ‚ Ğ½Ğ° ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ." },
        { q: "Ğ¡ ĞºĞµĞ¼ Ğ¸Ğ· Ğ±Ğ»Ğ¸Ğ·ĞºĞ¸Ñ… Ğ¸Ğ»Ğ¸ Ğ¼ÑƒĞ´Ñ€Ñ‹Ñ… Ğ»ÑĞ´ĞµĞ¹ Ğ²Ñ‹ Ğ¼Ğ¾Ğ³Ğ»Ğ¸ Ğ±Ñ‹ Ğ¾Ğ±ÑÑƒĞ´Ğ¸Ñ‚ÑŒ ÑÑ‚Ñƒ ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ñ?", p: "Ğ¡Ğ¾Ğ²ĞµÑ‚ (ÑˆÑƒÑ€Ğ°) â€” Ğ²Ğ°Ğ¶Ğ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚Ğ¸Ñ Ğ·Ğ½Ğ°Ñ‡Ğ¸Ğ¼Ñ‹Ñ… Ñ€ĞµÑˆĞµĞ½Ğ¸Ğ¹." },
    ];
    log("Ğ ĞµÑ„Ğ»ĞµĞºÑĞ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°");

    return {
        intentionQ: iq, consequenceQ: cq, valueQ: vq, metaQ: mq, logs,
        note: "Ğ­Ñ‚Ğ¸ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¿Ñ€ĞµĞ´Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ñ‹ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ğ¼Ñ‹ÑˆĞ»ĞµĞ½Ğ¸Ñ. ĞĞµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ ĞµĞ´Ğ¸Ğ½ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ Â«Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾Â» Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°. Ğ¦ĞµĞ»ÑŒ â€” Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ğ²Ğ°Ğ¼ Ğ³Ğ»ÑƒĞ±Ğ¶Ğµ Ğ¿Ğ¾Ğ½ÑÑ‚ÑŒ ÑĞ²Ğ¾Ğ¸ Ğ¼Ğ¾Ñ‚Ğ¸Ğ²Ñ‹ Ğ¸ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ğµ Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑÑ‚Ğ²Ğ¸Ñ."
    };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PIPELINE & UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.addEventListener("DOMContentLoaded", async () => {
    const statsEl = document.getElementById("stats-info");
    const btnEl = document.getElementById("analyze-btn");
    btnEl.disabled = true;

    // Show loading progress in stats badge
    const onProgress = (msg) => { statsEl.textContent = msg; };

    await loadAllData(onProgress);

    // Remove loading indicator
    const dotEl = document.querySelector(".badge-dot");
    if (dotEl) dotEl.classList.remove("badge-loading");

    // Update stats
    const entries = getAllEntries();
    const qc = entries.filter(e => e.type === "quran").length;
    const hc = entries.filter(e => e.type === "hadith").length;
    const pc = entries.filter(e => e.type === "principle").length;
    statsEl.textContent = `Ğ‘Ğ°Ğ·Ğ°: ${entries.length} Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¾Ğ² â€” ${qc} Ğ°ÑÑ‚Ğ¾Ğ², ${hc} Ñ…Ğ°Ğ´Ğ¸ÑĞ¾Ğ², ${pc} Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ğ¾Ğ²`;
    btnEl.disabled = false;

    // Character counter
    const ta = document.getElementById("situation-input");
    const counter = document.getElementById("char-count");
    ta.addEventListener("input", () => { counter.textContent = ta.value.length + " ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²"; });
});

function analyzeSubmit() {
    if (!DATA_LOADED) { alert("Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ĞµÑ‰Ñ‘ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ÑÑ‚ÑÑ, Ğ¿Ğ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ..."); return; }
    const ta = document.getElementById("situation-input");
    const btn = document.getElementById("analyze-btn");
    const situation = ta.value.trim();
    if (situation.length < 10) { alert("ĞĞ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ñ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½ĞµĞµ (Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 10 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²)."); ta.focus(); return; }

    btn.classList.add("loading"); btn.disabled = true;

    setTimeout(() => {
        try {
            const analyst = runAnalyst(situation);
            const values = runValues(situation, analyst);
            const reflection = runReflection(situation, analyst, values);
            const allLogs = [...analyst.logs, ...values.logs, ...reflection.logs];

            // Disclaimer
            const disc = document.getElementById("disclaimer");
            document.getElementById("disclaimer-text").textContent =
                "âš ï¸ Ğ”Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ğ¿Ñ€ĞµĞ´Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ¸ Ğ² Ñ€Ğ°Ğ·Ğ¼Ñ‹ÑˆĞ»ĞµĞ½Ğ¸Ğ¸ Ğ¸ ĞĞ• Ğ¯Ğ’Ğ›Ğ¯Ğ•Ğ¢Ğ¡Ğ¯ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼ Ğ¼Ğ¾Ñ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼ ÑÑƒĞ¶Ğ´ĞµĞ½Ğ¸ĞµĞ¼. Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ½Ğµ Ğ·Ğ°Ğ¼ĞµĞ½ÑĞµÑ‚ Ğ²Ğ°ÑˆÑƒ ÑĞ¾Ğ²ĞµÑÑ‚ÑŒ, ĞºĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ñ†Ğ¸Ñ Ñ ÑƒÑ‡Ñ‘Ğ½Ñ‹Ğ¼Ğ¸ Ğ¸Ğ»Ğ¸ ÑÑ€Ğ¸Ğ´Ğ¸Ñ‡ĞµÑĞºÑƒÑ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒ. Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ÑÑ Ğ·Ğ° Ğ²Ğ°Ğ¼Ğ¸.";
            disc.style.display = "flex";

            document.getElementById("results-section").style.display = "flex";
            renderAnalyst(analyst);
            renderValues(values);
            renderReflection(reflection);
            renderLogs(allLogs);

            document.getElementById("results-section").scrollIntoView({ behavior: "smooth", block: "start" });
        } catch (e) { alert("ĞÑˆĞ¸Ğ±ĞºĞ°: " + e.message); }
        finally { btn.classList.remove("loading"); btn.disabled = false; }
    }, 300);
}

function esc(s) { if (!s) return ""; const d = document.createElement("div"); d.textContent = String(s); return d.innerHTML; }

// â”€â”€ Render Analyst â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAnalyst(data) {
    const body = document.getElementById("analyst-body");
    let h = "";
    h += `<div class="sub-section"><div class="sub-title">ğŸ“Š Ğ ĞµĞ·ÑĞ¼Ğµ</div><p style="font-size:.88rem;color:var(--text-secondary);line-height:1.6">${esc(data.summary)}</p></div>`;

    h += `<div class="sub-section"><div class="sub-title">ğŸ‘¥ Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸</div><div class="stakeholder-list">`;
    for (const s of data.stakeholders) h += `<div class="stakeholder-chip"><span>${esc(s.name)}</span><span class="stakeholder-role">Â· ${esc(s.role)}</span></div>`;
    h += `</div></div>`;

    h += `<div class="sub-section"><div class="sub-title">âš¡ ĞšĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ½Ñ‹Ğµ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹</div>`;
    for (const c of data.conflicts) h += `<div class="conflict-item"><div class="conflict-type">${esc(c.type)}</div><div class="conflict-desc">${esc(c.desc)}</div><span class="conflict-severity">${esc(c.sev)}</span></div>`;
    h += `</div>`;

    h += `<div class="sub-section"><div class="sub-title">ğŸ”® ĞŸĞ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑÑ‚Ğ²Ğ¸Ñ</div>`;
    for (const c of data.consequences) h += `<div class="consequence-item"><div class="consequence-stakeholder">${esc(c.who)}</div><div class="consequence-row consequence-positive">âœ… ${esc(c.pos)}</div><div class="consequence-row consequence-negative">âš ï¸ ${esc(c.neg)}</div></div>`;
    h += `</div>`;

    h += `<div class="agent-note">â„¹ï¸ ${esc(data.note)}</div>`;
    body.innerHTML = h;
}

// â”€â”€ Render Values â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderValues(data) {
    const body = document.getElementById("values-body");
    let h = "";
    for (const [key, group] of Object.entries(data.sources)) {
        h += `<div class="source-group"><div class="source-group-label">${esc(group.label)}</div>`;
        for (const item of group.items) {
            h += `<div class="source-item"><div class="source-title">${esc(item.title)}</div>`;
            if (item.arabic) h += `<div class="source-arabic">${esc(item.arabic)}</div>`;
            h += `<div class="source-content">${esc(item.content)}</div><div style="margin-top:6px"><span class="source-reference">${esc(item.ref)}</span>`;
            if (item.grade) h += ` <span class="source-authenticity">${esc(item.grade)}</span>`;
            h += ` <span class="source-relevance">ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğ¹: ${item.score}</span></div></div>`;
        }
        h += `</div>`;
    }

    h += `<div class="sub-section"><div class="sub-title">ğŸ” Ğ Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ¿Ñ€ĞµÑ‚Ğ°Ñ†Ğ¸Ğ¸</div>`;
    for (const i of data.interpretations)
        h += `<div class="interpretation-item"><div class="interpretation-perspective">${esc(i.perspective)}</div><div class="interpretation-desc">${esc(i.desc)}</div><div class="interpretation-note">ğŸ’¡ ${esc(i.note)}</div></div>`;
    h += `</div>`;

    h += `<div class="agent-note">â„¹ï¸ ${esc(data.note)}</div>`;
    body.innerHTML = h;
}

// â”€â”€ Render Reflection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderReflection(data) {
    const body = document.getElementById("reflection-body");
    let h = "";
    const cats = [
        { key: "intentionQ", icon: "ğŸ¯", title: "Ğ’Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¾ Ğ½Ğ°Ğ¼ĞµÑ€ĞµĞ½Ğ¸ÑÑ…" },
        { key: "consequenceQ", icon: "ğŸ”®", title: "Ğ’Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¾ Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑÑ‚Ğ²Ğ¸ÑÑ…" },
        { key: "valueQ", icon: "ğŸ’", title: "Ğ’Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¾ Ñ†ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑÑ…" },
        { key: "metaQ", icon: "ğŸ§ ", title: "ĞœĞµÑ‚Ğ°Ñ€ĞµÑ„Ğ»ĞµĞºÑĞ¸Ñ" },
    ];
    for (const cat of cats) {
        const qs = data[cat.key] || [];
        if (!qs.length) continue;
        h += `<div class="question-category"><div class="question-category-title">${cat.icon} ${cat.title}</div>`;
        for (const q of qs) h += `<div class="question-item"><div class="question-text">${esc(q.q)}</div><div class="question-purpose">${esc(q.p)}</div></div>`;
        h += `</div>`;
    }
    h += `<div class="agent-note">â„¹ï¸ ${esc(data.note)}</div>`;
    body.innerHTML = h;
}

// â”€â”€ Render Logs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLogs(logs) {
    const c = document.getElementById("logs-container");
    let h = "";
    for (const l of logs) {
        const t = l.time ? new Date(l.time).toLocaleTimeString("ru-RU") : "";
        h += `<div class="log-entry"><span class="log-time">${esc(t)}</span><span class="log-agent">${esc(l.agent)}</span><span class="log-action">${esc(l.action)}</span></div>`;
    }
    c.innerHTML = h || '<p style="color:var(--text-muted);font-size:.8rem">ĞĞµÑ‚ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹</p>';
}

function toggleLogs() {
    const b = document.getElementById("meta-body");
    const t = document.getElementById("meta-toggle");
    const open = b.style.display !== "none";
    b.style.display = open ? "none" : "block";
    t.classList.toggle("open", !open);
}
